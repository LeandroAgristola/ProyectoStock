{% extends "products/products_layout.html" %}
{% load static %}

{% block product_content %}
    <form method="get" class="mb-4">
    <div class="row g-2 align-items-end">

        <!-- Campo de búsqueda -->
        <div class="col-md-6 position-relative">
            <div class="input-group">
                <input type="text" name="search" id="search"
                        value="{{ filters.search|default_if_none:'' }}"|
                        class="form-control" placeholder="Buscar producto...">
                <button class="btn btn-secondary" type="submit">
                    <i class="fa-solid fa-search"></i>
                </button>
                <button class="btn btn-primary" type="button" id="btnFilterToggle" title="Mostrar/Ocultar filtros">
                    <i class="fa-solid fa-filter"></i>
                </button>
            </div>
        </div>

        <!-- Filtros (colapsables) -->
        <div id="advancedFilters" class="mb-4 {% if not filters.category and not filters.status %}d-none{% endif %}">
            <div class="col-md-6 position-relative">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label for="category" class="form-label">Categoría:</label>
                        <select name="category" id="category" class="form-select">
                            <option value="">Todas las categorías</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if category.id|stringformat:"s" == filters.category %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="status" class="form-label">Estado de Stock:</label>
                        <select name="status" id="status" class="form-select">
                            <option value="">Todos los estados</option>
                            <option value="in_stock" {% if filters.status == 'in_stock' %}selected{% endif %}>En Stock</option>
                            <option value="out_of_stock" {% if filters.status == 'out_of_stock' %}selected{% endif %}>Sin Stock</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary me-2" type="submit">Aplicar</button>
                        <a href="{% url 'products:product_list' %}" class="btn btn-secondary">Limpiar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </form>
    
    <!-- Tabla de productos disponibles -->
    <div class="table-responsive mt-3">
        <table class="table table-hover table-striped">
            <thead class="table-light">
                <tr>
                    <th>Código</th>
                    <th>Producto</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td>{{ product.code|default:"N/A" }}</td>
                    <td>{{ product.name }}</td>
                    <td>{{ product.category.name }}</td>
                    <td>${{ product.price|floatformat:2 }}</td>
                    <td>
                        <span class="badge {% if product.stock > 0 %}bg-success{% else %}bg-danger{% endif %}">
                            {% if product.stock > 0 %} {{ product.stock }}{% else %}Sin stock {% endif %}
                        </span>
                    </td>
                    <td>
                        <a href="{% url 'products:product_edit' product.id %}" class="btn btn-sm btn-outline-primary" title="Editar">
                            Editar
                        </a>
                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ product.id }}" title="Eliminar (a papelera)">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <!-- Modal para confirmar eliminación -->
                        <div class="modal fade" id="deleteModal{{ product.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Eliminar Producto</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        ¿Estás seguro de mover el producto <strong>{{ product.name }}</strong> a la papelera?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <form method="post" action="{% url 'products:product_delete' product.id %}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger">Confirmar</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No hay productos disponibles.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        document.getElementById('btnFilterToggle').addEventListener('click', function() {
            const filtersDiv = document.getElementById('advancedFilters');
            filtersDiv.classList.toggle('d-none');
            this.title = filtersDiv.classList.contains('d-none') ? 'Mostrar filtros' : 'Ocultar filtros';
        });
    </script>
{% endblock product_content %}
